# FTP

## 1. 什么是FTP

**FTP**为`File Transfer Protocol`的缩写，即文件传输协议，是`TCP/IP `协议族中的协议之一。**FTP**是一个用于在计算机网络上在客户端和服务器之间进行文件传输的应用层协议.

该协议是Internet文件传送的基础，它由一系列规格说明文档组成，目标是提高文件的共享性，提供非直接使用远程计算机，使存储介质对用户透明 和可靠高效地传送数据。简单的说，FTP就是完成两台计算机之间的拷贝，从远程计算机拷贝文件至自己的计算机上，称之为“下载 （download）”文件。若将文件从自己计算机中拷贝至远程计算机上，则称之为“上载（upload）”文件。

**在TCP/IP协议中， 需要两个端口，一个是数据端口，一个是控制端口**。

**控制端口一般为21，而数据端口不一定是20**，这和FTP的应用模式有关，如果是主动模式，应该为20，如果为被动模式，由服务器端和客户端协商而定。相比于HTTP，FTP协议要复杂得多。复杂的原因，是因为FTP协议要用到两个TCP连接，一个是命令链路，用来在FTP客户端与服务器之间传递命令；另一个是数据链路，用来上传或下载数据。



## 2. 文件传输过程

**FTP**使用简单并不意味着其实现简单。与常见的应用层协议**http**只需要一个**TCP连接**不同，**FTP**需要两个**TCP连接**来完成文件的传输。其中一个称为**控制连接**，一个称为**数据连接**。同大多数Internet服务一样，**FTP也是一个客户/服务器系统**。用户通过一个客户机程序连接至在远程计算机上运行的服务器程序。依照 FTP 协议提供服务，进行文件传送的计算机就是 FTP 服务器，而连接FTP服务器，遵循FTP协议与服务器传送文件的电脑就是FTP客户端。用户要连上 FTP 服务器，就要用到 FPT 的客户端软件，通常 Windows自带“ftp”命令

如下图所示，描述了使用**FTP**进行文件传输的过程，用户通过**客户端程序**（ftp命令行或FileZilla）与FTP服务器**进行交互。用户的输入逻辑会被**用户协议解释器**解析，转换成**FTP命令**，通过控制连接（一个tcp连接，port口为21）给到**服务器协议解释器**，服务器协议解释器会回应一个**FTP应答**。并且根据传输过来的FTP命令类型，服务器协议解释器可能需要去启动**服务器数据传输功能**，其过程包括服务器主动发起建立一个tcp连接（用port口20），通过该连接服务端和客户端就可以进行数据传输了。在数据传输完成后，服务端会将该数据连接关闭掉，直到下一次需要文件传输时才又开启，所以可以看到数据连接是随时开、随时关**。而**控制连接在被创建后，其会一直保持下去**，随时等待用户命名的输入，直到主动断开。

![image-20230313202335990](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230313202335990.png)



## 3. FTP用户授权

### 3.1 用户授权

要连上 FTP 服务器（即“登陆”），必须要有该 FTP 服务器授权的帐号，也就是说你只有在有了一个用户标识和一个口令后才能登陆FTP服务器，享受FTP服务器提供的服务。常规的登录格式如下所示。

```
FTP地址如下： ftp://用户名：密码@FTP服务器IP或域名：FTP命令端口/路径/文件名

上面的参数除FTP服务器IP或域名为必要项外，其他都不是必须的。如以下地址都是有效FTP地址：

ftp://foolish.6600.org

ftp://list:list@foolish.6600.org

ftp://list:list@foolish.6600.org:2003

ftp://list:list@foolish.6600.org:2003/soft/list.txt
```



### 3.2 匿名授权

互连网中有很大一部分 FTP 服务器被称为“匿名”（Anonymous）FTP 服务器。这类服务器的目的是向公众提供文件拷贝服务，不要求用户事先在该服务器进行登记注册，也不用取得FTP服务器的授权。Anonymous（匿名文 件传输）能够使用户与远程主机建立连接并以匿名身份从远程主机上拷贝文件，而不必是该远程主机的注册用户。用户使用特殊的用户名“anonymous”登 陆FTP服务，就可访问远程主机上公开的文件。许多系统要求用户将Emai1地址作为口令，以便更好地对访问进行跟综，有的甚至不要邮箱便可以直接登录。匿名FTP一直是Internet 上获取信息资源的最主要方式，在Internet成千上万的匿名FTP主机中存储着无以计数的文件，这些文件包含了各种各样的信息，数据和软件。**人们只要 知道特定信息资源的主机地址，就可以用匿名FTP登录获取所需的信息资料。虽然目前使用WWW环境已取代匿名FTP成为最主要的信息查询方式，但是匿名 FTP仍是 Internet上传输分发软件的一种基本方法**。如red hat 、autodesk等公司的匿名站点。



## 4.报文格式

在FTP协议中，**FTP命令**和**FTP应答**，是以`ASCII码`形式的明文传递。**FTP命令**的一般报文格式是：`命令 选项参数 \r\n`，**FTP应答**的一般报文格式为：`状态码 报文选项 \r\n`。先来介绍**FTP命令**。

**FTP命令**都是`3`或`4`个字节的**大写ASCII字符**组成，其中一些命令带选项参数。从客户端向服务器发送的FTP命令有很多，在`rfc959`中有定义。本节介绍一些常用的。

| 命令                   | 解释                                                  |
| ---------------------- | ----------------------------------------------------- |
| ABOR                   | 放弃先前的FTP命令和数据传输                           |
| LIST filelist          | 列表显示文件或目录                                    |
| PASS password          | 服务器上的密码                                        |
| PORT n1,n2,n3,n4,n5,n6 | 客户端IP地址（n1 .n2 .n3 .n4）和端口（n5 × 256 + n6） |
| QUIT                   | 从服务器退出                                          |
| RETR filename          | 检索（取）一个文件                                    |
| STOR filename          | 存储（放）一个文件                                    |
| TYPE type              | 说明文件类型：A表示ASCII码，I表示二进制类型           |
| SYST                   | 服务器返回系统类型                                    |
| USER username          | 服务器上用户名                                        |

**FTP应答**的状态码是ASCII码形式的**3位数字**，并且跟有报文选项。

| 状态码 | 解释                                 |
| ------ | ------------------------------------ |
| 150    | 文件状态良好，打开数据连接           |
| 200    | 命令成果                             |
| 212    | 目录状态                             |
| 213    | 文件状态                             |
| 110    | 重新启动标记应答                     |
| 500    | 格式错误，命令不可识别               |
| 501    | 参数语法错误                         |
| 502    | 命令未实现                           |
| 120    | 在X分钟内准备好                      |
| 125    | 连接打开准备传送                     |
| 214    | 帮助信息，信息仅对人类用户有用       |
| 215    | 名字系统类型                         |
| 220    | 对新用户服务准备好                   |
| 221    | 服务关闭控制连接，可以退出登录       |
| 225    | 数据连接打开，无传输正在进行         |
| 226    | 关闭数据连接，请求的文件操作成功     |
| 227    | 进入被动模式                         |
| 230    | 用户登录成功                         |
| 331    | 用户名正确，需要口令                 |
| 332    | 登陆时需要庄户信息                   |
| 350    | 请求的文件需要进一步命令             |
| 421    | 连接用户过多                         |
| 425    | 不能打开数据连接                     |
| 426    | 关闭连接，中止传输                   |
| 450    | 请求的文件操作未执行                 |
| 451    | 终止请求的操作，有本地错误           |
| 452    | 未执行的请求的操作：系统存储空间不足 |
| 250    | 请求的文件操作完成                   |
| 257    | 创建“PATHNAME”                       |
| 503    | 命令顺序错误                         |
| 504    | 此参数下的命令功能未实现             |
| 530    | 账号或者密码错误                     |
| 532    | 存储文件需要账户信息                 |
| 550    | 未执行请求的操作                     |
| 551    | 请求操作终止，页类型未知             |
| 552    | 请求的文件操作终止，存储分配溢出     |
| 553    | 未执行的请求操作:文件名不合法        |

## 5. FTP的文件传输格式

FTP协议的任务是从一台计算机将文件传送到另一台计算机，它与这两台计算机所处的位置、联接的方式、甚至是是否使用相同的操作系统无关。假设两台 计算机通过ftp协议对话，并且能访问Internet，你可以用ftp命令来传输文件。每种操作系统使用上有某一些细微差别，但是每种协议基本的命令结 构是相同的。

FTP的传输有两种方式：ASCII传输模式和二进制数据传输模式。

### 5.1 ASCII传输方式

假定用户正在拷贝的文件包含的简单ASCII码文本，如果在远程机器上运行的不是UNIX，当文件传输时ftp通常会自动地调整文件的内容以便于把文件解释成另外那台计算机存储文本文件的格式。但是常常有这样的情况，用户正在传输的文件包含的不是文本文件，它们可能是程序， 数据库，字处理文件或者压缩文件（尽管字处理文件包含的大部分是文本，其中也包含有指示页尺寸，字库等信息的非打印符）。**在拷贝任何非文本文件之前，用 binary 命令告诉ftp逐字拷贝，不要对这些文件进行处理，这也是下面要讲的二进制传输。**

### 5.2二进制传输模式

在二进制传输中，保存文件的位序，以便原始和拷贝的是逐位一一对应的。即使目的地机器上包含位序列的文件是没意义的。例 如，macintosh以二进制方式传送可执行文件到Windows系统，在对方系统上，此文件不能执行。如果你在ASCII方式下传输二进制文件，即使 不需要也仍会转译。这会使传输稍微变慢 ，也会损坏数据，使文件变得不能用。（在大多数计算机上，ASCII方式一般假设每一字符的第一有效位无意义，因为ASCII字符组合不使用它。如果你传 输二进制文件，所有的位都是重要的。）如果你知道这两台机器是同样的，则二进制方式对文本文件和数据文件都是有效的。



## 6. FTP工作模式

### 6.1 主动模式（PORT）

其发起数据连接过程为，客户端通过`PORT`命令将客户端监听的端口号传递给服务端，**服务端**通过固定的`20`端口主动去和客户端监听的端口进行TCP连接，此连接就是**数据连接**。可以看到如果**客户端的防火墙阻止了服务器的主动连接请求**，那么数据连接就会失败。所以主动模式有一定缺陷。

述的这种连接模式就是主动模式，**主动是相对于服务端来说的**。下图示意了**主动模式**过程，控制连接是客户端发起，数据连接是服务端发起。

![image-20230313212331000](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230313212331000.png)

### 6.2 被动模式(PASV)

为了解决**主动模式**所面临的问题，FTP协议也支持**被动模式**，通过网络数据包来看一下**被动模式**的交互过程。客户端通过发送`PASV`，表明客户端明确告知FTP服务器它使用被动模式。被动模式的示意图如下图所示：控制连接和数据连接都由客户端主动发起，而且服务端数据连接端口不在是固定端口`20`，而是被分配了一个临时端口。因为两次连接都是客户端主动发起，所以就不会有防火墙的问题。

![image-20230313212424079](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230313212424079.png)

### 6.3 被动模式出现的案例

在FTP的历史中，本来只有主动模式的，但是为什么又出现了被动模式呢?这又牵涉到另外一个问题了，

共享上网就是很 多台电脑共享一个公网IP去使用internet，再打个比喻吧，某个局域网共享210.33.25.1这个公网IP上网，当一个内网用户 192.168.0.100去访问外网的FTP服务器时，如果采用主动模式的话，192.168.0.1告诉了FTP服务器我需要某个文件和我打开了x端 口之后，由于共享上网的原因，192.168.0.1在出网关的时候自己的IP地址已经被翻译成了210.33.25.1这个公网IP，所以服务器端收到 的消息也就是210.33.25.1需要某个文件并打开了x端口，FTP服务器就会往210.33.25.1的x端口传数据，这样当然会连接不成功了，因为打开x端口的并不是210.33.25.1这个地址，在这种情况下被动模式就有用了，相信大家已经能够理解被动模式是怎么个连接法了吧。

　　**在主动模式中，****FTP**的两个端口是相对固定的，如果命令端口是**x**的话，那数据端口就是**x-1**，也就是说默认情况下，命令端口是**21**，数据端口就**是**20;**你把命令端口改成了**123**，那么数据端口就是**122**。这样使用防火墙就很方便了，只要开通这两个端口就可以了，但是如果客户端是共享上网的话那岂****不是不能正常使用**FTP**了，这样还是不行，一定需要被动模式。

　　**在被动模式中就麻烦了些，默认情况下命令端口是**21**，但是数据端口是随机的**



## 7. 传输过程详细展示

### 7.1 主动连接

#### 7.1.1 主动连接介绍

服务端通过制定端口号（20）主动与客户端建立数据连接，并向客户端发送数据。

以下报文是SNAT转换后的报文，**源IP（10.10.10.2）转换成出接口IP地址（192.168.10.114）**

#### 7.1.2 **报文拆分解释**

1. 报文1-3:TCP建立三次握手，建立连接

![image-20230314193237082](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314193237082.png)

2. 报文4：服务端（21端口）向客户端（49203端口）发送request报文。code字段表示新用户服务就绪，arg字段为服务器名称和服务器版本号

![image-20230314193329926](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314193329926.png)

3. 报文5：客户端（49203端口）向服务端（21端口）发送request报文。command字段表示该报文里包含的是用户名，arg字段为用户名内容。

![image-20230314193555391](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314193555391.png)

	4. 报文6：服务端（21端口）回复response报文，code值为331，表示用户名可以，需要密码。

![image-20230314193818425](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314193818425.png)

 5. 报文7：客户端（49203端口）向服务端（21端口）发送request报文，command字段表示该报文里包含的是密码，arg字段为密码内容。

    ![image-20230314194217540](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314194217540.png)

	6. 报文8：服务端（21端口）回复response报文，code值为230，表示用户已登录，请继续操作

![image-20230314194424080](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314194424080.png)

7. 报文9：客户端（49203端口）向服务端（21端口）发送**SYST**报文，表示返回服务器使用的操作系统。

![image-20230314194535839](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314194535839.png)

8. 报文10：服务端（21端口）回应系统类型，code字段为215，表示返回的是系统类型。arg字段为UNIX，表示系统类型是UNIX系统。

![image-20230314194845640](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314194845640.png)



 9. ​    

    包11：客户端（49203端口）请求系统状态

    包12：服务端（21端口）回应系统状态，code字段为211，arg字段为特征列表。

    ![image-20230314195452372](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314195452372.png)

	10. ​    

     包15：客户端（49203端口）PWD获取当前路径

     包16：服务端（21端口）返回当前路径

     包17：客户端（49203端口）CWD更改目录

     包18：服务端（21端口）返回修改后的目录

     包19：客户端（49203端口）PWD获取当前路径

     包20：服务端（21端口）返回当前路径

     ![image-20230314195721027](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314195721027.png)

	11.    

     包21：客户端（49203端口）请求使用ascii传输

     包22：服务端（21端口）响应，同意使用ascii传输

     ![image-20230314195824992](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314195824992.png)

	12.   

     包23：客户端（49203端口）发起主动连接，向服务端发送建立子连接的IP和端口。

     包24：服务端（21端口）响应，同意使用客户端发送的IP端口建立子连接。

     ![image-20230314200037393](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314200037393.png)

	13. 包26-28：FTP子连接三次握手建立TCP连接。

![image-20230314204741030](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314204741030.png)

14. 包30-32：服务端（20端口）向客户端（49204端口）发送数据。

    ![image-20230314204902036](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314204902036.png)

15. 包33-37：数据传输完成，TCP断开连接。

![image-20230314204956262](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314204956262.png)

16. 包60-63：控制连接已断开，TCP四次挥手断开TCP连接

    ![image-20230314205043306](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314205043306.png)

### 7.2 被动连接

1. 报文1-3：TCP三次握手建立TCP连接

![image-20230314205329133](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314205329133.png)

2. 报文4：服务端（21端口）向客户端（49206端口）。code字段表示新用户服务就绪，arg字段为服务器名称和服务器版本。

   ![image-20230314205421879](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314205421879.png)

3. 报文5：客户端（49206端口）向服务端（21端口）发送request报文。command字段表示该报文里包含的是用户名，arg字段为用户名内容。

   ![image-20230314205545333](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314205545333.png)

4. 报文6：服务端（21端口）回复response报文，code值为331，表示用户名可以，需要密码

![image-20230314205611114](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314205611114.png)

5. 报文7：客户端（49206端口）向服务端（21端口）发送request报文，command字段表示该报文里包含的是密码，arg字段为密码内容。![image-20230314205648839](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314205648839.png)

6. 报文8：服务端（21端口）回复response报文，code值为230，表示用户已登录，请继续操作![image-20230314205807770](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314205807770.png)

7. 报文9：客户端（49206端口）向服务端（21端口）发送SYST报文，表示返回服务器使用的操作系统。![image-20230314210051189](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210051189.png)

8. 报文10：服务端（21端口）回应系统类型，code字段为215，表示返回的是系统类型。arg字段为UNIX，表示系统类型是UNIX系统。![image-20230314210148390](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210148390.png)



9.   

   包11：客户端（49206端口）请求系统状态

   包12：服务端（21端口）回应系统状态，code字段为211，arg字段为特征列表![image-20230314210237236](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210237236.png)

10.   包15：客户端（49206端口）PWD获取当前路径

    包16：服务端（21端口）返回当前路径

    包17：客户端（49206端口）CWD更改目录

    包18：服务端（21端口）返回修改后的目录

    包19：客户端（49206端口）PWD获取当前路径

    包20：服务端（21端口）返回当前路径

    ![image-20230314210324686](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210324686.png)

11.    包23：客户端（49206端口）向服务端请求建立被动连接

    包24：服务端（21端口）响应，同意建立被动连接，并且向客户端发送服务端的IP和监听端口。![image-20230314210417035](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210417035.png)

12.   包26-28：FTP子连接三次握手建立TCP连接。![image-20230314210505433](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210505433.png)

13.  包：32-33：服务端（20端口）向客户端（49207端口）发送数据。![image-20230314210811814](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210811814.png)

14. 包：32-33：服务端（52564端口）向客户端（49207端口）发送数据。![image-20230314210858244](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210858244.png)

15. 包34-36：数据传输完成，TCP断开连接![image-20230314210943080](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314210943080.png)

16.   包59-62：控制连接已断开，TCP四次挥手断开TCP连接![image-20230314211021951](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230314211021951.png)


## 8. 思考


### 8.1、主动模式和被动模式是谁决定的
主动模式和被动模式是由客户端决定的，客户端请求建立数据连接时，发送PVSA报文，服务端就会建立被动连接；当客户端发送PORT报文时，服务端就会建立主动连接。

### 8.2、主动模式和被动模式是怎么协商出端口
主动模式协商端口

1、客户端使用任意一个的非熟知权端口N（N>1024）与服务端建立FTP控制连接，然后客户端开始监听N+1端口。客户端向服务端21端口发送PORT报文，PORT报文里包含客户端监听的IP和N+1端口。

2、服务端收到客户端的PORT报文后，使用客户端发送的IP和N+1端口与客户端建立数据连接。

被动模式协商端口

客户端开启FTP连接时，会打开两个任意的非熟知端口（N > 1024和N+1）。N端口连接服务器的21端口。
客户端发送PVSA报文给服务端
服务器会开启一个任意的非熟知端口（P > 1024），并发送响应报文给客户端响应报文包含服务端IP和端口号P。
客户端发起从本地端口N+1到服务器的端口P建立数据连接。
### 8.3、设想中间防火墙怎么识别子连接并给子连接放行
被动模式：

客户端开启FTP连接时，会打开两个任意的非熟知端口（N > 1024和N+1）。N端口连接服务器的21端口。
客户端发送PVSA报文给服务端。
服务器会开启一个任意的非熟知端口（P > 1024），并发送响应报文给客户端，响应报文包含服务端子连接IP和端口P。
防火墙收到服务端的响应后，获取响应报文中子连接的IP和端口P。
客户端发起从本地端口N+1到服务器的子连接IP、端口P建立数据连接。
防火墙收到客户端发送的报文目的IP是子连接IP后，允许转发，并转发给服务器。
### 8.4、思考NAT设备如何给子连接做地址转换
主动模式：

客户端使用任意一个的非熟知端口N（N>1024）与服务端建立FTP控制连接
客户端监听N+1端口。
客户端向服务端21端口发送PORT报文建立子连接，PORT报文里包含客户端监听的IP和N+1端口。
NAT设备获取PORT报文内的客户端IP和N+1端口
NAT设备修改PORT报文内的客户端IP和N+1端口为自己的IP和端口，生成动态NAT
服务端收到客户端的PORT报文后，使用NAT转换后的IP和端口与客户端建立数据连接。
NAT设备收到后，访问转换后的IP和端口，根据动态NAT转换为客户端子连接的IP和N+1端口，发送给客户端。

### 8.5、下载两个文件，会每个文件开一个数据连接么
FTP同时下载两个文件，FTP会为每个文件打开一个数据连接。



## 9. 参考链接

[(177条消息) FTP协议报文详解及FTP穿越NAT_ftp报文格式_孤风落影的博客-CSDN博客](https://blog.csdn.net/ever_peng/article/details/89022796)

[【FTP】详解 - peterYong - 博客园 (cnblogs.com)](https://www.cnblogs.com/peterYong/p/8630542.html)

[详解ftp协议，力荐！！！ - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/543119629)

[(177条消息) 网络编程之FTP文件传输协议_ftp边读编边写_HelloA666的博客-CSDN博客](https://blog.csdn.net/Aaron133/article/details/78508211?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-78508211-blog-87809034.pc_relevant_landingrelevant&spm=1001.2101.3001.4242.2&utm_relevant_index=4)

