# Ioc容器

## 1. 背景

### 1.1 IOC

1. Ioc是一个容器
2. 容器启动时创建所有单实例对象
3. 我们可以直接从容器中获取到这个对象

### 1.2 SpringIOC

1. ioc容器的启动过程?启动期间都做了什么(什么时候创建了所有的单例bean)
2. ioc是如何创建这些单实例bean，并如何管理的；到底保存在了哪里?



## 2. 思路

### 2.1 ClassPathXMLApplication构造器

```java
ioc = new ClassPathXmlApplicationContext("application.xml");
```

### 2.2 ClassPathXmlApplicationContext调用构造器

```java
public class ClassPathXmlApplicationContext extends AbstractXmlApplicationContext {
    private Resource[] configResources;
	
    // configLocations是类路径下的xml文件名
    public ClassPathXmlApplicationContext(String... configLocations) throws BeansException {
        this(configLocations, true, (ApplicationContext)null);
    }
    
    // 最终所有的构造器，都会落脚到这三个参数的构造器上面。
     public ClassPathXmlApplicationContext(String[] configLocations, boolean refresh, ApplicationContext parent) throws BeansException {
        super(parent);
        this.setConfigLocations(configLocations);
        if (refresh) {
            // ！！！！ 调用refresh方法才会创建对象
            this.refresh();
        }
    }

}
```

### 2.3 AbstractApplicationContext.refresh方法

```java
public void refresh() throws BeansException, IllegalStateException {
    synchronized(this.startupShutdownMonitor) {
        // 此时完成ioc容器创建
        this.prepareRefresh();
        // ApplicationContext继承与beanFactory工厂
        ConfigurableListableBeanFactory beanFactory = this.obtainFreshBeanFactory();
        this.prepareBeanFactory(beanFactory);

        try {
            this.postProcessBeanFactory(beanFactory);
            this.invokeBeanFactoryPostProcessors(beanFactory);
            this.registerBeanPostProcessors(beanFactory);
            // 用了支持国际化功能
            this.initMessageSource();
            // 初始化事件转发器
            this.initApplicationEventMulticaster();
            // 留给子类实现的
            this.onRefresh();
            // 注册监听器
            this.registerListeners();
            // 初始化所有单实例bean的地方
            this.finishBeanFactoryInitialization(beanFactory);
            this.finishRefresh();
        } catch (BeansException var5) {
            this.destroyBeans();
            this.cancelRefresh(var5);
            throw var5;
        }
    }
}
```

- this.prepareRefresh();

此时ioc容器被创建:信息: Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@7b69c6ba: startup date [Sun Apr 16 15:59:32 CST 2023]; root of context hierarchy

- ConfigurableListableBeanFactory beanFactory = this.obtainFreshBeanFactory();

**Spring解析xml配置文件将要创建的所有bean的配置信息保存起来**

四月 16, 2023 4:01:43 下午 org.springframework.beans.factory.xml.XmlBeanDefinitionReader loadBeanDefinitions
信息: Loading XML bean definitions from class path resource [application.xml]

![image-20230416160609715](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20230416160609715.png)

- this.finishBeanFactoryInitialization(beanFactory);

初始化所有的bean的地方

```java
protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {
        if (beanFactory.containsBean("conversionService") && beanFactory.isTypeMatch("conversionService", ConversionService.class)) {
            beanFactory.setConversionService((ConversionService)beanFactory.getBean("conversionService", ConversionService.class));
        }

        String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);
        String[] var3 = weaverAwareNames;
        int var4 = weaverAwareNames.length;

        for(int var5 = 0; var5 < var4; ++var5) {
            String weaverAwareName = var3[var5];
            this.getBean(weaverAwareName);
        }

        beanFactory.setTempClassLoader((ClassLoader)null);
        beanFactory.freezeConfiguration();
    	// 初始化所有单实例的bean
        beanFactory.preInstantiateSingletons();
    }
```

- DefaultListableBeanFactory.preInstantiateSingletons

```java
    public void preInstantiateSingletons() throws BeansException {
        // 日志文件
        if (this.logger.isDebugEnabled()) {
            this.logger.debug("Pre-instantiating singletons in " + this);
        }
        ArrayList beanNames;
        synchronized(this.beanDefinitionMap) {
            // 拿到所有要创建的bean的id号
            beanNames = new ArrayList(this.beanDefinitionNames);
        }
		// 获取beansName的迭代器，按照配置的顺序从上到下
        Iterator var2 = beanNames.iterator();

        while(true) {
            while(true) {
                String beanName;
                RootBeanDefinition bd;
                do {
                    do {
                        do {
                            if (!var2.hasNext()) {
                                return;
                            }
							// 获取到bean名称
                            beanName = (String)var2.next();
                            // 获取getMergedLocalBeanDefinition获取bean的定义信息
                            bd = this.getMergedLocalBeanDefinition(beanName);
                            // 是抽象的
                        } while(bd.isAbstract());
                        // 是单例的
                    } while(!bd.isSingleton());
                    // 是懒加载
                } while(bd.isLazyInit());
				
                // 是否是工厂bean
                if (this.isFactoryBean(beanName)) {
                    final FactoryBean<?> factory = (FactoryBean)this.getBean("&" + beanName);
                    boolean isEagerInit;
                    if (System.getSecurityManager() != null && factory instanceof SmartFactoryBean) {
                        isEagerInit = (Boolean)AccessController.doPrivileged(new PrivilegedAction<Boolean>() {
                            public Boolean run() {
                                return ((SmartFactoryBean)factory).isEagerInit();
                            }
                        }, this.getAccessControlContext());
                    } else {
                        isEagerInit = factory instanceof SmartFactoryBean && ((SmartFactoryBean)factory).isEagerInit();
                    }

                    if (isEagerInit) {
                        this.getBean(beanName);
                    }
                } else {
                    // ！！！创建对象
                    // 本质上是调用doGetBean方法
                    this.getBean(beanName);
                }
            }
        }
    }
```

 ### 2.4 AbstractBeanFactory.doGetBean方法

```java
    protected <T> T doGetBean(String name, Class<T> requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException {
        final String beanName = this.transformedBeanName(name);
        // 在单例池中查找是否已经有 已经注册的bean
        Object sharedInstance = this.getSingleton(beanName);
        Object bean;
        if (sharedInstance != null && args == null) {
            if (this.logger.isDebugEnabled()) {
                if (this.isSingletonCurrentlyInCreation(beanName)) {
                    this.logger.debug("Returning eagerly cached instance of singleton bean '" + beanName + "' that is not fully initialized yet - a consequence of a circular reference");
                } else {
                    this.logger.debug("Returning cached instance of singleton bean '" + beanName + "'");
                }
            }

            bean = this.getObjectForBeanInstance(sharedInstance, name, beanName, (RootBeanDefinition)null);
        } else {
            if (this.isPrototypeCurrentlyInCreation(beanName)) {
                throw new BeanCurrentlyInCreationException(beanName);
            }

            BeanFactory parentBeanFactory = this.getParentBeanFactory();
            if (parentBeanFactory != null && !this.containsBeanDefinition(beanName)) {
                String nameToLookup = this.originalBeanName(name);
                if (args != null) {
                    return parentBeanFactory.getBean(nameToLookup, args);
                }

                return parentBeanFactory.getBean(nameToLookup, requiredType);
            }

            if (!typeCheckOnly) {
                // 设置标志，防止多线程重复创建
                this.markBeanAsCreated(beanName);
            }

            try {
                // 根据beanName获取当前bean的定义信息
                final RootBeanDefinition mbd = this.getMergedLocalBeanDefinition(beanName);
                this.checkMergedBeanDefinition(mbd, beanName, args);
                // 获取当前bean依赖bean对象
                String[] dependsOn = mbd.getDependsOn();
                // 多例对象数组
                String[] prototypeInstance;
                // 如果集合不为空
                if (dependsOn != null) {
                    prototypeInstance = dependsOn;
                    int var12 = dependsOn.length;

                    for(int var13 = 0; var13 < var12; ++var13) {
                        String dependsOnBean = prototypeInstance[var13];
                        if (this.isDependent(beanName, dependsOnBean)) {
                            throw new BeanCreationException("Circular depends-on relationship between '" + beanName + "' and '" + dependsOnBean + "'");
                        }

                        this.registerDependentBean(dependsOnBean, beanName);
                        this.getBean(dependsOnBean);
                    }
                }
				// 创建bean实例
                if (mbd.isSingleton()) {
                    sharedInstance = this.getSingleton(beanName, new ObjectFactory<Object>() {
                        public Object getObject() throws BeansException {
                            try {
                                // 完成bean的创建，同时创建好的对象，会被放置在singlentonObject容器中，ioc就是一个容器。
                                
                                return AbstractBeanFactory.this.createBean(beanName, mbd, args);
                            } catch (BeansException var2) {
                                AbstractBeanFactory.this.destroySingleton(beanName);
                                throw var2;
                            }
                        }
                    });
                    bean = this.getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
                } else if (mbd.isPrototype()) {
                    prototypeInstance = null;

                    Object prototypeInstance;
                    try {
                        this.beforePrototypeCreation(beanName);
                        prototypeInstance = this.createBean(beanName, mbd, args);
                    } finally {
                        this.afterPrototypeCreation(beanName);
                    }

                    bean = this.getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
                } else {
                    String scopeName = mbd.getScope();
                    Scope scope = (Scope)this.scopes.get(scopeName);
                    if (scope == null) {
                        throw new IllegalStateException("No Scope registered for scope '" + scopeName + "'");
                    }

                    try {
                        Object scopedInstance = scope.get(beanName, new ObjectFactory<Object>() {
                            public Object getObject() throws BeansException {
                                AbstractBeanFactory.this.beforePrototypeCreation(beanName);

                                Object var1;
                                try {
                                    var1 = AbstractBeanFactory.this.createBean(beanName, mbd, args);
                                } finally {
                                    AbstractBeanFactory.this.afterPrototypeCreation(beanName);
                                }

                                return var1;
                            }
                        });
                        bean = this.getObjectForBeanInstance(scopedInstance, name, beanName, mbd);
                    } catch (IllegalStateException var21) {
                        throw new BeanCreationException(beanName, "Scope '" + scopeName + "' is not active for the current thread; " + "consider defining a scoped proxy for this bean if you intend to refer to it from a singleton", var21);
                    }
                }
            } catch (BeansException var23) {
                this.cleanupAfterBeanCreationFailure(beanName);
                throw var23;
            }
        }

        if (requiredType != null && bean != null && !requiredType.isAssignableFrom(bean.getClass())) {
            try {
                return this.getTypeConverter().convertIfNecessary(bean, requiredType);
            } catch (TypeMismatchException var22) {
                if (this.logger.isDebugEnabled()) {
                    this.logger.debug("Failed to convert bean '" + name + "' to required type [" + ClassUtils.getQualifiedName(requiredType) + "]", var22);
                }

                throw new BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());
            }
        } else {
            return bean;
        }
    }

```

