# 配置文件-backlog深度解析

## 1. backlog解释

![image-20221128193037695](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128193037695.png)

tcp-backlog是一个tcp连接的队列，其主要是用于解决高并发场景下的**慢连接问题,**这里设置的值就是这个队列的长度，该队列和TCP连接的三次握手有关，不同的Linux内核，backlog队列中存放的元素(客户端连接)类型是不同的。

- Linux内核2.2版本之前，该队列中存放的是已完成第一次握手的所有客户端连接，其中就包含已经完成三次握手的客户端连接。当然，此时的backlog队列中的连接也具有两种状态:未完成三次握手的客户端连接状态为SYN_RECEIVE，已经完成三次握手的连接状态为ESTABISHED,只有ESTABISHED状态的连接才会被Redis处理。
- Linux内核2.2以后的版本，TCP系统中维护了两个队列:SYN_RECEIVE与ESTABLISHED队列。SYN_RECEIVED队列中存放的是未完成三次握手的连接，ESTABLISHED队列中存放的是已经完成三次握手的连接，此时的backlog就是ESTABLISHED队列。

## 2. 查看系统内核

```sh
# 方法一
uname -a

# 方法二
cat /proc/version
```

![image-20221128194631620](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128194631620.png)

## 3. backlog长度

### 3.1 共同决定参数

TCP中的backlog队列的长度再Linux中的内核参数somaxconn来决定的。在Redis中的该队列的长度由Redis配置文件与somaxconn共同决定，取两者的最小值,查看内核中的最小值命令如下。

```
cat /proc/sys/net/core/somaxconn
```

![image-20221128195005269](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128195005269.png)

**在高并发生产场景下，backlog的值最好要大一些，否则可能会影响性能**

### 3.2 修改内核参数

```sh
# 打开配置文件
vim  /etc/sysctl.conf

# 在文件末尾添加
net.core.somaxconn=2048


# 不停机的条件下修改系统配置文件的内容
sysctl -p
```

- 打开文件并且添加

![image-20221128195744322](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128195744322.png)

- 修改结果

![image-20221128200116137](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128200116137.png)

- 进行测试

![image-20221128200146684](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128200146684.png)



## 4. 三次握手与四次挥手示意图

![image-20221128204241135](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128204241135.png)

TCP连接建立的过程就是建立两个通道的过程，需要经过三次握手

![image-20221128204404094](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128204404094.png)

TCP断开连接，就是释放两个通道的过程，需要进行四次挥手

![image-20221128204516405](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221128204516405.png)