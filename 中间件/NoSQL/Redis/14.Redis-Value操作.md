# Redis-Value操作

## 1. String类型的Value操作

​	Redis存储数据的Value可以是一个String类型的数据，String的value时Redis中最常见的类型，String类型的Value中可以存放任意数据，包括数值型、甚至是二进制的图片，音频，序列化对象，一个String类型的value大小最大时512M.

 ### 1.1 set

- 格式:set key value [ex|px] [nx|xx]
- 功能：SET除了可以直接将key的值设置为Value外，还可以指定一些参数
  - ex:为当前的key设置过期时间，**单位秒**,相当于setex
  - px:为当前的key设置过期时间，**单位是毫秒**，相当于psetex
  - nx:指定的key不存在才会设置成功，用于添加指定的key，相当于setnx命令
  - xx:指定的key不存在才会设置成功，用于更新指定的key
- 说明:如果设置的value字符串中带有空格，则该字符串需要使用双引号或者单引号引起来，否则会认为set命令的参数不正确，报错

### 1.2 setex与psetex

- 格式: SETEX与PSETEX key seconds value

- 功能:set expire，其不仅仅key指定了value，还为其设置了生存时间，setex的单位为秒，psetex单位为毫秒

- 说明:如果key已经存在了，则覆写旧值，该命令类似于以下两个命令

  - set key value
  - expire key seconds # 设置生存时间

  不同之处是，**setex是一个原子操作，关联值和生存时间的两个动作会在同一时间内完成**，该命令在Redis用作缓存的时候，非常实用



### 1.3 setnx

- 格式:SETNX key value
- 功能:SET if Not exists，将key的值设为value，当且仅当key不存在时，若给定的key已经存在了，则setnx不做任何动作。成果返回1，失败返回0
- 说明:该命令等价于 set key value nx



### 1.4 getset

- 格式:GETSET key value
- 功能:将给定的key的值设为value，并返回key的旧值
- 说明:当key存在但不是字符串类型时，返回一个错误；当key不存在时，返回nil



### 1.5 mset或者msetnx

- 格式;MSET/MSETNX key value {key value key value}
- 功能:如果设置一个或多个 key-value
- 说明:如果某个给定key已经存在，那么MSET会用新的值覆盖原来旧的值，如果这不是你所希望的效果，请考虑使用MSETNX命令，**它只会在所有给定的key都不存在的时候下进行设置操作**。MSET/MSETNX是一个原子操作，所有给定的key都会在同一时间内被设置，某些给定key被更新而另外一些key没有改变的情况不可能发生，该命令永不会失败。



### 1.6 mget

- 格式:MGET key {key ......}
- 功能:返回所有（一个或者多个）给定key的值
- 说明:如果给定key里面，若某个key不存在，那么这个key返回特殊值nul。因此该命令用不失败



### 1.7 append

- 格式:append key value
- 功能：如果key已经存在并且是一个字符串，append命令将value追加到key原来的值的尾部。如果key不存在，append就简单地将给定的key设置为value，就像执行set key value
- 说明:追加value以后，key中字符串的长度



### 1.8 incr与decr

- 格式:INCR key 或者 DECR key

- 功能:increment，自动递增，将key中存储的数字值增一

  ​		decrement，自动递减，将key中存储的数字值减一

- 说明:如果key不存在，那么key的值会被初始化为0，然后再执行赠一/减一操作，如果值不能表示为数字，那么就会返回一个错误提示;如果执行正确，则返回增一、减一的值



### 1.9 incrby和decrby

- 格式:INCRBY key increment 或者 DECRBY key decrement
- 功能:将key中存储的数字值增减/减少指定的数值，这个数值只能是整数，可以是负数但是不能是小鼠
- 说明:如果key不存在，那么keu的值会被先初始化为0，然后再执行增/减操作，如果值不能表示为数字，那么返回一个错误提示，如果执行正确，则返回增/减后的值。



### 1.10 incrbyfloat

- 格式:incrbyfloat key increment
- 功能:为key中所存储的值加上浮点数增量increment.
- 说明:与之前的说明相同，没有decrbyfloat命令，但是increment为负数可以实现减操作



### 1.11 strlen

- 格式:strlen key
- 功能:返回 key 所存储的字符串值得长度



### 1.12 getrange

- 格式: GETRANGE key start end
- 功能;返回key中的字符串中，字符串的截取范围由start和end两个偏移量决定，包括start和end在内
- 说明:end必须要比start大，支持负数偏移量，表示从字符串最后开始计数，-1表示最后一个字符，-2表示倒数第二个，以此类推



### 1.13 setrange

- 格式:SETRANGE key offset value
- 功能:用value参数替换给定key所存储的字符串值str，从偏移量offset开始
- 说明:当offset值大于str长度时，中间使用零字节 \x00填充，即0000 0000字节填充，对于不存在的key当作空串处理



## 2.String类型的value应用场景

### 2.1 数据缓存

​		redis作为数据访问层，Mysql作为数据存储层，应用服务器首先应该从redis中获取数据，如果缓存中没有，则从MySQL中获取后先存入缓存层然后再返回给应用服务器。

### 2.2 计数器

​		在Redis中写入一value为数值型的value值作为平台计数器，视频播放计数器等。每个有效客户端访问一次，或者斯视频每播放一次，都是直接修改redis中的计数器，然后再以异步方式持久化转到其他的数据源中，例如持久化mysql中。

### 2.3 共享Session

​		对于一个分布式应用系统，如果将类似于用户登录信息这样的Session数据保存在提供登录服务的服务器中，那么如果用户再次提交像收藏、支付类似的请求可能会出现问题；在提供收藏、支付等服务的服务器中并没有该用户的数据Session数据，从而导致该用户需要登录。对于用户来说，这是不能接受的。

​		此时，可以将系统中的所有用户的Session数据全部保存到Redis中，用户在提交新的请求后，系统会从Redis中查找相应的Session数据，如果存在。则再进行相关操作，否则跳转到登录页面。这样就不会引发操作”重新登录问题“。

![image-20221202104541986](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221202104541986.png)

## 2.4 限速器

​		现在很多平台为了防止Dos攻击，一般都会限制一个IP不能在每分钟内访问超过n次，而Redis可以结合key的过期时间与incr命令来完成限速功能，充当限速器。

​		注意，其无法提交DDos攻击(分布式拒绝服务攻击)

```
// 客户端每提交一次代码，都会执行下面的代码
// 等价于 set 192.168.55.1 ex 60 nx
// 指定新的IP作为key的缓存过期时间60s
Boolean isExists = redis.set(ip,1,"EX 60","nx");
if(isExists != null || redis.incr(ip) < 5){
	//通过
}else{
	//不通过
}
```

