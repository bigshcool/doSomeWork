# 简单动态字符串SDS

## 1.SDS简介

​		无论是Redis的Key还是Value，其基础数据类型都是字符串。例如，Hash型是Value的field与value的类型，List型，Set型，ZSet型value元素类型都是字符串类型。虽然Redis是使用标准的C语言开发的，但是并没用直接使用C语言中传统的字符串表示，而是自定义了一种字符串。这种字符串本身的结构是比较简单的，但是功能却非常强大，简称为动态字符串，Simple Dynamic String，简称SDS。

​		**注意,Redis中所有的字符串并不都是SDS,也会出现C字符串，C字符串只会出现字面常量中，并且该字符串不可能发生变更，例如返回结果**

## 2.SDS结构

​		SDS不同于C字符串，c字符串本身是一个以双引号括起来，以空字符串“\0”结尾的字符序列，但是SDS是一个结构体，定义在Redis安装目录下的src/sds.h中。

```c
struct sdshdr{
	// 字节数组，用于保存字符串
	char buf[];
	// buf[]中已使用字节数量，成为SDS的长度
	int len;
	// buf[]中尚未使用的字节数量
	int free;
}
```

​		例如，执行SET country “China”命令时，键country与值“China”都是SDS类型的，只不过一个时SDS变量，一个是SDS的字面常量，“China”在内存中的结构如下所示:

![image-20221212112130062](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221212112130062.png)

​	可以看出buf其实就是C语言中的字符串，其中len和free都是不算"\0"的长度

![image-20221212111821049](https://raw.githubusercontent.com/bigshcool/myPic/main/image-20221212111821049.png)

​	注意type是看变量属于之前所说的五种类型中的哪一种，而object encoding key 是看在内存中的存储方式。



## 3.SDS优势

​		C字符串使用len+1长度的字符串数组来表示实际长度为Len的字符串，字符数组最后以空字符串“\0”,表示字符串结束，这种结构简单，但是不能满足Redis对字符串的功能需要，安全性以及等效性。



### 3.1 防止“字符串长度获取”性能瓶颈

​		对于C字符串，若要获取其长度，则必须要通过遍历整个字符串才可获取到的，对于超长字符串的遍历，会成为系统的性能瓶颈。

​		但，由于SDS结构体中直接存放着字符串的长度数据，所以对于获取字符串长度需要消耗的系统性能，与字符串本身长度是无关的，不会成为Redis的性能瓶颈。



### 3.2 保障二进制安全

​		C字符串中只能半酣某种编码格式的字符串，例如ASCII，UTF-8等，并且除了字符串末尾外，其他的位置是不能包含空字符“\0”的，否则该字符换就会被程序误以为提前结束，而在图片，音频，视频，压缩文件，office文件等二进制文件中以空字符串“\0”作为分隔符的情况是很常见的，故而C字符串中是不能保存图像，音频，视频，压缩文件，office文件等二进制数据等。

​		但是SDS不是以空字符"\0"作为字符串结束标志的，其是通过len属性来判断字符串是否结束的。所以，对于程序处理SDS中的字符串数据，无需对数据做任何限制，过滤、假设，只需要读取即可，数据写入时什么，读到的就是什么。



### 3.3 减少内存再分配次数

​		SDS采用了**空间预分配策略与惰性空间释放策略**来避免内存再分配问题。

​		空间预分配策略，每次SDS进行空间拓展时，程序不但为其分配所需的空间，还会为其分配额外的未使用空间，以减少内存再次分配次数。而额外分配未使用空间大小取决于空间扩展后的SDS的len属性值。

- 如果len属性值小于1M，那么分配的未使用空间free大小与len属性值相同

- 如果len属性值大于1M，那么分配的未使用空间free的大小固定是1M.

  SDS对于空间释放采用的惰性空间释放策略，该策略是指，SDS字符串都如果缩短，那么多出的未使用空间暂时不释放，而是添加到free中。以使后期扩展SDS时减少内存再分配次数。

  如果要释放SDS的未使用空间，则可通过sdsRemoveFressSpace()函数来释放。

  

### 3.4  兼容C函数

​		Redis中提供了很多SDS的API,以方便用户对Redis进行二次开发。为了能够兼容C函数，SDS的底层数组buf[]中的字符串仍以空字符串“\0”结尾。



